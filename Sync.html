<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>eGate | Sync</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/Content/jquery.mobile-1.4.0.min.css">
    <link rel="stylesheet" href="/Content/Views/Default.min.css">
    <link rel="stylesheet" href="/Content/Views/Sync/Default.min.css">
    <script type="text/javascript" src="/scripts/jquery-2.1.0.min.js"></script>
    <script type="text/javascript" src="/scripts/jquery.mobile-1.4.0.min.js"></script>
    <script type="text/javascript" src="/scripts/Views/Sync/Default.min.js"></script>
    <script type="text/javascript" src="/scripts/localstoragedb.js"></script>
</head>
<body>
    <div data-role="page">
        <div data-role="header">
            <div data-role="navbar" data-iconpos="left">
                <ul>
                    <li><a href="/Index.html" rel="external" data-icon="home">Home</a></li>
                    <li><a href="/Index.html" rel="external" data-icon="star">Sales</a></li>
                    <li><a href="#pnlReports" data-icon="grid">Reports</a></li>
                </ul>
            </div>
            <h1><img src="/Images/32x32/Sync.png" alt="" width="32" height="32" /> Synchronize</h1>
        </div>

        <div data-role="content">
            <select id="DeviceID" data-native-menu="false" multiple="multiple">
                <option>Select Devices</option>
                <option value="All">[ All Devices ]</option>
                <option value="1T30MSILAC670">1T30MSILAC670</option>
                <option value="1T30MSILAC671">1T30MSILAC671</option>
                <option value="1T30MSILAC672">1T30MSILAC672</option>
                <option value="1T30MSILAC673">1T30MSILAC673</option>
            </select>

            <a class="ui-btn"  onclick="SyncDevices()"><img src="/Images/32x32/Refresh.png" alt="" width="32" height="32" /> Refresh Devices</a>
            <a class="ui-btn" data-transition="pop" data-rel="popup" onclick="CheckDB()"><img src="/Images/32x32/Bluetooth.png" alt="" width="32" height="32" /> Bluetooth Push</a>

            <fieldset id="fsDeviceType" data-role="controlgroup" data-type="horizontal">
                <legend></legend>
                <label for="DeviceType1">Master</label>
                <input name="DeviceType" id="DeviceType1" type="radio" value="1" checked="checked">
                <label for="DeviceType0">Satellite</label>
                <input name="DeviceType" id="DeviceType0" type="radio" value="0">
            </fieldset>
            <div id="jqResult"></div>
        </div>

        <div data-role="footer" data-position="fixed">
            <span>© Copyright 2014</span>
        </div>
        
        <div id="pnlReports" data-role="panel" data-display="overlay">
            <h2 data-rel="close"><img src="/Images/48x48/Chart.gif" alt="" width="32" height="32" />Reports</h2>
            <ul data-role="listview">
                <li><a>Out of Stock Summary</a></li>
                <li><a href="#popupNotEnabled" data-rel="popup">Change Due</a></li>
                <li><a href="/Reports/SalesSummary.html" data-rel="external">Sales Summary</a></li>
                <li><a href="/Reports/StockSummary.html" data-rel="external">Stock Summary</a></li>
                <li><a href="/Reports/Payment.html" data-rel="external">Payment</a></li>
                <li><a href="/Reports/CategorySalesSummary.html" data-rel="external">Category Sales Summary</a></li>
                <li><a href="/Reports/ItemsSold-Pax.html" data-rel="external">Items Sold / Pax</a></li>
            </ul>
        </div>

        <div id="popupNotEnabled" data-role="popup">
            <p><img src="/Images/32x32/Info.png" alt="" width="32" height="32" /> Sorry, but this feature has not yet been enabled.</p>
        </div>
    </div>
</body>
    <script>
        dbShell = window.openDatabase("InflightDB", 1, "InflightDB", 1000000);

        function phoneReady() {
            //First, open our db    

            //run transaction to create initial tables
            dbShell.transaction( setupTable, dbErrorHandler, getEntries);
        }

        //I just create our initial table - all one of em
        function setupTable(tx) {
            tx.executeSql("CREATE TABLE IF NOT EXISTS menuitems(itemid INTEGER PRIMARY KEY,itemname varchar(50), usdprice varchar(50))");
        }

        function dbErrorHandler(err) {
            alert("DB Error: " + err.message + "\nCode=" + err.code);
        }

        //I handle getting entries from the db
        function getEntries() {

            dbShell.transaction(function (tx) {
                tx.executeSql("DELETE FROM menuitems")}, dbErrorHandler);
            
            // Get Menu items
            // Call web service for menu items
            // http://localhost:60919/DeviceSync.asmx/SyncMenuItems
            $.ajax({
                type: 'POST',
                url: 'http://mobiledevws.devstuff.us/DeviceSync.asmx/SyncMenuItems',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: function (results) {
                    var nData = $.parseJSON(results.d);

                    // Add new ones
                    $.each(nData, function (i, item) {
                        var sql = "INSERT INTO menuitems(itemid, itemname, usdprice) values('" + item.ItemID + "', '" + item.ItemName + "', '" + item.USDPrice + "')";

                        dbShell.transaction(function (tx) {
                            tx.executeSql(sql)}, dbErrorHandler);
                    });

                    var ret = "<table><tr><td>Item</td><td>Price</td></tr>";
                    $.each(nData, function (i, item) {
                        ret = ret + "<tr><td>" + item.ItemName + "</td><td>" + item.USDPrice + "</td></tr>"
                    });

                    ret = ret + "</table>"

                    $("#jqResult").html(ret);
                },
                error: function (results) { window.status = "ERROR WorkItems_RemoveRow():" + results.status + " " + results.statusText; }
            });
        }

        function SyncDevices() {
            phoneReady();
        }
    </script>
</html>
